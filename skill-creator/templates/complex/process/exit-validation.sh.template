#!/bin/bash
# Node {{NODE_INDEX}}: {{NODE_NAME}} - Exit Validation
# {{NODE_DESCRIPTION}}

set -e

WORKSPACE_DIR="$HOME/.claude/skills/{{SKILL_NAME}}/workspace"
OUTPUT_FILE="$WORKSPACE_DIR/{{NODE_OUTPUT_FILE}}"

echo "=== Node {{NODE_INDEX}}: {{NODE_NAME}} Exit Validation ==="
echo ""

# Check 1: Output file exists
echo -n "Checking output file exists... "
if [ ! -f "$OUTPUT_FILE" ]; then
    echo "FAILED"
    echo "  Error: $OUTPUT_FILE not found"
    exit 1
fi
echo "OK"

# Check 2: File is valid JSON
echo -n "Checking valid JSON... "
if ! jq empty "$OUTPUT_FILE" 2>/dev/null; then
    echo "FAILED"
    echo "  Error: Invalid JSON in output file"
    exit 1
fi
echo "OK"

# Check 3: Status is completed
echo -n "Checking status... "
STATUS=$(jq -r '.status // empty' "$OUTPUT_FILE")
if [ "$STATUS" != "completed" ]; then
    echo "FAILED"
    echo "  Error: Node status is '$STATUS', expected 'completed'"
    exit 1
fi
echo "OK"

# Add node-specific validations below
# Example:
# echo -n "Checking required_field... "
# FIELD=$(jq -r '.output.required_field // empty' "$OUTPUT_FILE")
# if [ -z "$FIELD" ]; then
#     echo "FAILED"
#     echo "  Error: required_field is missing"
#     exit 1
# fi
# echo "OK"

echo ""
echo "=== All validations passed ==="
echo ""
echo "Ready to proceed to {{NEXT_NODE}}"
exit 0
